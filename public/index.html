<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeChat</title>
    <!-- SVG icons js link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- stylesheet link/ -->
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <a href="about.html"><div class="heading">DeChat</div></a>
    
    <a href="about.html">New to <b>DeChat</b>? , Click here !</a>
    
    <button id="createKey">Create Key</button>
    <div class="joinArea">
        <input type="text" id="roomKey" placeholder="Enter Room Key"><a href="#bottom"><button id="joinRoom">Join</button></a>
    </div>

    <div id="displayRoomKey"></div>

    <div id="memberColorBalls"></div>
    
    <div id="chatBox"></div>

    <div id="replyPreviewContainer"></div>
    <div id="imageContainer"></div>

    <div class="sendArea">

        <textarea id="message" placeholder="Type freely..." rows="1"/></textarea>
        <input type="file" id="fileInput" style="display: none;" accept="image/*">
        
        <div class="sendAreaBtns">

            <button id='sendbtn'><i class="fa-solid fa-paper-plane"></i></button>
            <button id="fileBtn" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-paperclip"></i></button>
            
            <a name="bottom"></a>
        </div>        
    </div>

    <script src="https://dechat-o5h4.onrender.com/socket.io/socket.io.js"></script>
    <script>
        const user = io('https://dechat-o5h4.onrender.com')
        const sendbtn = document.getElementById('sendbtn')
        const roomKey = document.getElementById('roomKey')
        const joinBtn = document.getElementById('joinRoom')
        const keyBtn = document.getElementById('createKey')
        const receiveSound = new Audio('receive.wav')
        const leaveSound = new Audio('newJoin1.wav')
        const delSound = new Audio('Remove_Msg.flac')
        const fileInput = document.getElementById('fileInput')
        let chatBox = document.getElementById('chatBox')
        let replyPreviewContainer = document.getElementById('replyPreviewContainer')
        let message = document.getElementById('message')
        let imageContainer = document.getElementById('imageContainer')
        let memberColorBalls = document.getElementById('memberColorBalls')
        let displayRoomKey = document.getElementById('displayRoomKey')
        
        // Varibles to store critical information at the frontend 
        /*  Note:
                Any variable changed from this below section may break the code , 
                as it contains necessary booleans and certain information user specific that is 
                stored at the frontend , Hence , handle the below variables with care ;) ,this information includes :
                1. The key of the room
                2. HASHED user id provided by the socket.io framework , which is stored at the frontend for
                    for some features
                3. file data being sent 
                4. type of the file being sent
         */
        let key = ''
        let user_id = ''
        let fileData = ''
        let fileType = ''
        let isEdit = false
        let isJoined = false
        let isScrolling = false
        let isFile = false
        let msg_to_edit_index = null


        // To ensure empty values when user first loads the web for the first time
        message.value = ''
        roomKey.value = ''

        // Function to generate the random key , 11 characters in length
        keyBtn.addEventListener('click' , (e) => {
            key = ''
            if(isJoined) return
            let chars = 'ABCDEFGHIJKL0123456789MNOPQRST@$&_UVWXYZ'
            let nums = ''
            for(let i = 0 ; i<11 ; i++){
                let index = Math.floor(Math.random()*chars.length)
                key += chars[index]
            }
            console.log(key)
            user.emit('joinRoom' , key )
            isJoined = true
            displayRoomKey.innerText = `Joined Room: ${key}`
            scrollToBottomWindow()
            roomKey.value = key
        })

        
        joinBtn.addEventListener('click' , (e) => {
            if(isJoined || roomKey.value < 11) return
            else if(roomKey.value === '') return
            else if(displayRoomKey.innerText === '') displayRoomKey.innerText = `Joined Room: ${roomKey.value}`
            user.emit('joinRoom' , roomKey.value )
            isJoined = true
        })

        fileInput.addEventListener('change' , () => {
            isFile = true
            let file = fileInput.files[0]
            let fileSize = (file.size/1024)
            if(fileSize > 350){
                replyPreviewContainer.innerHTML = `Too large file ! ,<br>
                currently we only support file upto 350 KB. <button class='cancelReplyBtn' onclick=cancelReply()><i class="fa-solid fa-xmark"></i></button>`
                cancelImg()
                return
            }
            if(file && file.type.startsWith("image/")){
                let reader = new FileReader()
                reader.readAsDataURL(file)
                reader.onload = () => {

                    imageContainer.innerHTML = `<img src='${reader.result}' />
                    <button onclick=cancelImg() id='cancelImgBtn'><i class="fa-solid fa-xmark"></button>`
                    fileData = reader.result
                    fileType = file.type
                    scrollToBottomWindow()

                }
            }
            else{
                replyPreviewContainer.innerHTML = `We only support IMAGES for now. <button class='cancelReplyBtn' onclick=cancelReply()><i class="fa-solid fa-xmark"></i></button>`
                cancelImg()
            }
        })

        function scrollToBottomWindow(){
            window.scrollTo({top: document.body.scrollHeight + 200 , behavior: "smooth"})
        }

        function cancelImg(){
            isFile = false
            imageContainer.innerHTML = ''
            fileInput.value = ''
        }

        
        let typingTimeout;
        message.addEventListener('focus' , () => {
            clearTimeout(typingTimeout)
            user.emit('typing')
        })

        message.addEventListener('blur' , () => {
            typingTimeout = setTimeout(() => {
                user.emit('stoppedTyping')
            } , 200)
        })



        user.on('TakeUserId' , (userId) => {
            if(user_id == ''){
                user_id = userId
            }
        })

        user.on('addtypingball' , (userColor , isBubble) => {
            if(!isBubble){
                let typingBubble = createTypingBubbleElement()
                chatBox.appendChild(typingBubble)
            }
            else{
                typingBubble = document.getElementById('typingBalls')
            }
            let ball = document.createElement('div')
            ball.setAttribute('class' , 'typingBall')
            ball.setAttribute('id' , `typing_ball_${userColor}`)
            ball.style.backgroundColor = userColor
            typingBubble.appendChild(ball)
            scrollToBottomChatBox()
        })

        function createTypingBubbleElement(){
            typingBubble = document.createElement('div')
            typingBubble.setAttribute('id' , 'typingBalls')
            return typingBubble
        }

        user.on('removetypingBall' , (userColor) => {
            let removeBall = document.getElementById(`typing_ball_${userColor}`)
            let typingBubble = document.getElementById('typingBalls')
            removeBall.remove()
            if(typingBubble.innerHTML === ''){
                typingBubble.remove()
                user.emit('updateBubbleFlag' , false)
            }
        })
        

        sendbtn.addEventListener('click' , (e) => {
            if(isFile){
                user.emit('sendFile' , fileData , fileType)
                console.log('sending the file... ' , fileData ,fileType)
                cancelImg()
                return
            }
            else if(message.value === ''){
                return
            }
            else if(isEdit){
                user.emit('editMsg' , msg_to_edit_index , message.value)
                message.value = ''
                return
            }
            user.emit('send_message' , message.value)
            message.value = ''
            console.log(message.value)
        })

        let scrollTimeout;
        chatBox.addEventListener('scroll' , () => {
            isScrolling = true

            clearTimeout(scrollTimeout)

            scrollTimeout = setTimeout(() => {
                isScrolling = false
            } , 800)
        })


        user.on('message', ({ msg, userColor }, sender, msg_index, file_flag , replying_flag , rmsg , rcolor) => {

            let msgContainer = document.createElement('div'); // Main container
            msgContainer.className = 'msgBubble';
            msgContainer.style.color = userColor;
            msgContainer.setAttribute('id', msg_index);
            render_msg({ msg, userColor }, sender, msg_index, file_flag , replying_flag , rmsg , rcolor,msgContainer)

            chatBox.appendChild(msgContainer); // Append entire bubble to chatBox

            if (chatBox.contains(typingBubble)) {
                chatBox.appendChild(typingBubble);
            }

            if(!isScrolling){
                scrollToBottomChatBox()
            }

        });

        user.on('receiveFile' , (sender , file_data , file_type , userColor , msg_index) => {
            let typingBubble = document.getElementById('typingBalls')
            let msgContainer = document.createElement('div') // Main container
            msgContainer.className = 'msgBubble'
            msgContainer.setAttribute('id', msg_index)
            msgContainer.style.border = `3px dashed ${userColor}`

            let newMsg = document.createElement('p');
            newMsg.className = 'messageContent';
            

            if(sender == user_id){
                msgContainer.style.borderRadius = '20px 20px 2px 20px'
                newMsg.innerHTML = `<img src=${file_data} class='chat-img' onclick=openImageWindow("${file_data}") />
                <button class='DelBtns' data-value='${msg_index}' onclick='removeMsg(${msg_index})'>
                    <i class="fa-solid fa-trash"></i>
                </button>`
            }
            else{
                msgContainer.style.borderRadius = '20px 20px 20px 2px'
                newMsg.innerHTML = `<img src=${file_data} class='chat-img' onclick=openImageWindow("${file_data}") />
                <button class='replyBtn' onclick='replyFile("${file_data}", "${userColor}")'>
                    <i class="fa-solid fa-reply"></i>
                </button>`
                receiveSound.play()
            }

            msgContainer.appendChild(newMsg)
            chatBox.appendChild(msgContainer)
            if (chatBox.contains(typingBubble)) {
                chatBox.appendChild(typingBubble);
            }
            scrollToBottomChatBox()
        })
        
        let imageWindow;
        function openImageWindow(data){
            imageWindow = window.open("" , "Image Window" , "_blank")
            if(imageWindow == null) return
            imageWindow.document.write(`
            <html>
                <head>
                    <title>Image Viewer</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
                    <style>
                        body{
                            background-color: #444;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                        }
                        .fullViewImage{
                            height: auto;
                            width: auto;
                            max-height: 80vh;
                            max-width: 80vw;
                            margin: auto;
                            border-radius: 10px;
                        }
                        .closeWindow{
                            background-color: black; 
                            color: white;
                            width: fit-content;
                            height: fit-content;
                            padding: 10px;
                            border-radius: 50px;
                            font-size: 9px;
                            font-weight: bold;
                            border: none;
                            display: flex;
                            align-self: flex-start;
                            justify-content: center;
                            cursor: pointer;
                            transition: 0.3s;
                            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
                            position: fixed;
                        }
                    </style>
                </head>
                <body>
                    <button class='closeWindow' onclick=window.close() > <i class="fa-solid fa-xmark"></i> </button>
                    <img src=${data} class='fullViewImage' />
                </body>
            </html>
            `)
        }

        function scrollToBottomChatBox(){
            chatBox.scrollTo({top: chatBox.scrollHeight , behavior: "smooth"})
        }

        function replyFile(file_data , color){
            replyPreviewContainer.innerHTML = ''
            let replyPreview = document.createElement('div')
            replyPreview.className = 'replyPreview'
            replyPreview.innerHTML = `
                <img src=${file_data} class='replyImg' />
                <button class='cancelReplyBtn' onclick=cancelReply()>
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `
            replyPreview.style.border = `3px dashed ${color}`
            replyPreview.style.borderRadius = '10px'
            replyPreviewContainer.appendChild(replyPreview)
            user.emit('update_reply_flag' , true , true , file_data , color)
            scrollToBottomWindow()
        }


        function reply(msg , color){
            replyPreviewContainer.innerHTML = ''
            let replyPreview = document.createElement('div')
            replyPreview.className = 'replyPreview'
            replyPreview.innerHTML = `Replying to: ${msg} <button class='cancelReplyBtn' onclick=cancelReply()><i class="fa-solid fa-xmark"></i></button>`
            replyPreview.style.color = color
            replyPreviewContainer.appendChild(replyPreview)
            console.log('before sending to backend: ' , msg , color)
            user.emit('update_reply_flag' , false , true , msg , color)
            scrollToBottomWindow()
        }

        function cancelReply(){
            replyPreviewContainer.innerHTML = ''
            user.emit('update_reply_flag' , false , false , '' , '')
        }


        user.on('msgEdited' , ({ msg , userColor } , sender , msg_index_for_edit , replying_flag_file , replying_flag , rmsg , rcolor) => {
            
            let editedMsgContainer = document.getElementById(msg_index_for_edit)
            editedMsgContainer.innerHTML = ''

            render_msg({ msg , userColor } , sender , msg_index_for_edit , replying_flag_file , replying_flag , rmsg , rcolor , editedMsgContainer)
            
            cancelEdit()
        })

        function render_msg({msg , userColor} , sender , msg_index , flag_file , flag_reply , rmsg , rcolor , msgContainer){

            if(flag_file){
                let replyMsg = document.createElement('div');
                replyMsg.className = 'replyMsg';
                replyMsg.style.border = `2px dashed ${rcolor}`;
                replyMsg.innerHTML = `
                    <img src=${rmsg} class='replyImg' onclick=openImageWindow("${file_data}")/>
                    <button class='replyBtn' onclick='replyFile("${rmsg}" , "${rcolor}")'>
                        <i class="fa-solid fa-reply"></i>
                    </button>
                `;
                cancelReply()
                msgContainer.appendChild(replyMsg)
            }
            else if(flag_reply){
                let replyMsg = document.createElement('div');
                replyMsg.className = 'replyMsg';
                replyMsg.style.color = rcolor;
                replyMsg.innerHTML = `
                    <span class="replyText">${rmsg}</span>
                    <button class='replyBtn' onclick='reply("${rmsg}" , "${rcolor}")'>
                        <i class="fa-solid fa-reply"></i>
                    </button>
                `;
                msgContainer.appendChild(replyMsg)
                cancelReply()
                replyPreviewContainer.innerHTML = ''
            }

            msgContainer.style.color = userColor
            let new_msg = document.createElement('p')
            new_msg.className = 'messageContent'

            new_msg.innerHTML = `<div>${msg}</div>`;
            if (sender == user_id) {
                msgContainer.style.borderRadius = '20px 20px 2px 20px'
                new_msg.innerHTML += `
                    <div class='msgBtnContainer'>
                        <button class='EditBtn' data-value='${msg_index}' onclick='editMsg(${msg_index}, "${msg}" , "${userColor}")'>
                            <i class="fa-solid fa-pencil"></i>
                        </button>
                        <button class='DelBtns' data-value='${msg_index}' onclick='removeMsg(${msg_index})'>
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            } else {
                msgContainer.style.borderRadius = '20px 20px 20px 2px'
                new_msg.innerHTML += `
                    <button class='replyBtn' onclick='reply("${msg}" , "${userColor}")'>
                        <i class="fa-solid fa-reply"></i>
                    </button>
                `;
                receiveSound.play();
            }
            msgContainer.appendChild(new_msg)
            return
        }

        function editMsg(edit_index , msg , color){
            isEdit = true
            replyPreviewContainer.innerHTML = ''
            let editPreview = document.createElement('div')
            editPreview.className = 'replyPreview'
            editPreview.innerHTML = `Editing: ${msg} <button class='cancelReplyBtn' onclick=cancelEdit()><i class="fa-solid fa-xmark"></i></button>`
            editPreview.style.color = color
            replyPreviewContainer.appendChild(editPreview)
            scrollToBottomWindow()
            message.value = msg
            msg_to_edit_index = edit_index
        }

        function cancelEdit(){
            isEdit = false
            replyPreviewContainer.innerHTML = ''
            message.value = ''
            msg_to_edit_index = null
        }


        function removeMsg(del_index){
            delSound.play()
            user.emit('deleteMsg' , del_index)
        }

        user.on('delfromChatBox' , (msgToDel) => {
            isFile = false
            let delmsg = document.getElementById(msgToDel)
            console.log('index returned from backend: ' , msgToDel)
            if(delmsg){
                delmsg.remove()
            }
        })

        user.on('userDisconnected' , () => {
            leaveSound.play()
        })

        user.on('addMemberBall' , (assignedColorsList) => {
            memberColorBalls.innerHTML = ''
            assignedColorsList.forEach((color) => {
                let ball = document.createElement('div')
                ball.setAttribute('class' , 'memberBall')
                ball.setAttribute('id' , color)
                ball.style.backgroundColor = color
                memberColorBalls.appendChild(ball)
            })
        })


        user.on('removeMemberColorBall' , (color) => {
            let memberColorBalls = document.getElementById('memberColorBalls')
            removeBall = document.getElementById(color)
            memberColorBalls.removeChild(removeBall)
        })

        user.on('RoomLimitReached' , (msg) => {
            displayRoomKey.innerText = msg
        })

        user.on('disconnected' , () => {
            message.value = ''
            displayRoomKey.value = ''
            memberColorBalls.value = ''
            roomKey.value = ''
            chatBox.innerHTML = ''
        })
    </script>
</body>
</html>